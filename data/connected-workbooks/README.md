Multiple connected Excel workbooks for the Inventory Ops dashboard.

Files generated by the script:
- MasterData.xlsx — Items, BOM, Vendors, Customers
- Transactions.xlsx — PO_Combined, SO_Combined, Receipts, Production, Movements
- Inventory.xlsx — StockSnapshot with formulas linking to the other two
- AI_Staging.xlsx — AI_Extract (purchases) and AI_Extract_Sales (sales) flat tables

Sample data
- 2 items: FG-100 (Finished Good), RM-200 (Raw Material)
- 5 vendors, 5 customers
- 5 POs, 5 Receipts, 5 SOs, 5 Production records
- Movements ledger includes receipts, production issues, production completions, and a couple of shipments

Refresh & links
- When you open Inventory.xlsx, Excel will prompt to update external links; allow it and keep MasterData.xlsx and Transactions.xlsx open for best results.

Power Query setup (optional but recommended)
Use the following M code in Inventory.xlsx to build a robust StockSnapshot from the other two workbooks (now using SO_Combined only; Incoming14d not available from AI invoices by default).

Steps
1) Open Inventory.xlsx → Data → Get Data → Launch Power Query Editor
2) Home → Manage Parameters → New Parameter: Name = FolderPath, Type = Text, Current Value = the absolute path to this folder
3) Home → New Source → Blank Query → Advanced Editor → paste this M code and name the query StockSnapshotPQ
4) Close & Load To… → Table on a new worksheet (or Data Model)

M code
let
  FolderPath = FolderPath,
  Master = Excel.Workbook(File.Contents(FolderPath & "MasterData.xlsx"), null, true),
  Items = Master{[Name="Items"]}[Content],
  Trans = Excel.Workbook(File.Contents(FolderPath & "Transactions.xlsx"), null, true),
  SOCombined = Trans{[Name="SO_Combined"]}[Content],
  Movements = Trans{[Name="Movements"]}[Content],

  // Types
  SOCombinedTyped = Table.TransformColumnTypes(SOCombined, {{"QtyOrdered", Int64.Type},{"AllocatedQty", Int64.Type}}),
  MovementsTyped = Table.TransformColumnTypes(Movements, {{"QtyDelta", Int64.Type},{"Date", type date}}),

  // Incoming14d not available from invoice-only AI extract (default 0)
  IncomingByPart = #table(type table[PartNo=Text, Incoming14d=Int64.Type], {}) ,

  // Reserved by part (Allocated)
  SOOpen = Table.SelectRows(SOCombinedTyped, each [LineStatus] = "Open"),
  ReservedByPart = Table.Group(SOOpen, {"PartNo"}, {{"Reserved", each List.Sum([AllocatedQty]), Int64.Type}}),

  // OnHand and LastMovement by part
  OnHandByPart = Table.Group(MovementsTyped, {"PartNo"}, {{"OnHand", each List.Sum([QtyDelta]), Int64.Type}, {"LastMovement", each List.Max([Date]), type date}}),

  // Combine
  ItemsSlim = Table.SelectColumns(Items, {"PartNo","PartName","Category","Min","Max","Location"}),
  Join1 = Table.NestedJoin(ItemsSlim, {"PartNo"}, OnHandByPart, {"PartNo"}, "onhand", JoinKind.LeftOuter),
  Exp1 = Table.ExpandTableColumn(Join1, "onhand", {"OnHand","LastMovement"}, {"OnHand","LastMovement"}),
  Join2 = Table.NestedJoin(Exp1, {"PartNo"}, ReservedByPart, {"PartNo"}, "res", JoinKind.LeftOuter),
  Exp2 = Table.ExpandTableColumn(Join2, "res", {"Reserved"}, {"Reserved"}),
  Join3 = Table.NestedJoin(Exp2, {"PartNo"}, IncomingByPart, {"PartNo"}, "inc", JoinKind.LeftOuter),
  Exp3 = Table.ExpandTableColumn(Join3, "inc", {"Incoming14d"}, {"Incoming14d"}),
  AddAvail = Table.AddColumn(Exp3, "Available", each (Number.FromNullable([OnHand]) ?? 0) - (Number.FromNullable([Reserved]) ?? 0), Int64.Type),
  AddStatus = Table.AddColumn(AddAvail, "Status", each if [Available] <= 0 then "Out" else if [Available] < ([Min] ?? 0) then "Low" else "Healthy", type text),
  Reorder = Table.ReorderColumns(AddStatus, {"PartNo","PartName","Category","OnHand","Reserved","Available","Incoming14d","Min","Max","Status","LastMovement","Location"})
in
  Reorder

Notes
- The Inventory.xlsx workbook already contains a StockSnapshot sheet with formulas that link to MasterData.xlsx and Transactions.xlsx. The Power Query above gives you a refreshable alternative in case you prefer PQ over cross-workbook formulas.

---

AI → Purchase/Sales (Power Query)
The generator already builds PO_Combined and SO_Combined in Transactions.xlsx from AI_Staging.xlsx.
If you still want normalized header/line tables, use the snippets below in Transactions.xlsx to project AI_Extract and AI_Extract_Sales into separate headers and lines.

Setup
1) Transactions.xlsx → Data → Get Data → Launch Power Query Editor
2) Manage Parameters → New Parameter: Name = FolderPath, Type = Text, Current Value = absolute path to this folder
3) New Query → Blank Query → Advanced Editor → paste the code below; name it `PO_From_AI`
4) Duplicate the query and rename to `POLines_From_AI` using the second block below
5) Optional: create `PO_Combined_From_AI` using the third block
6) Close & Load To… each query as a Table (or Append to existing tables)

PO_From_AI (headers)
let
  FolderPath = FolderPath,
  AI = Excel.Workbook(File.Contents(FolderPath & "AI_Staging.xlsx"), null, true),
  T = AI{[Name="AI_Extract"]}[Content],
  Renamed = Table.TransformColumnTypes(T, {{"PurchaseOrder", type text},{"VendorName", type text},{"InvoiceId", type text},{"InvoiceDate", type date}}),
  Dedup = Table.Distinct(Table.SelectColumns(Renamed,{"PurchaseOrder","VendorName","InvoiceDate"})),
  Master = Excel.Workbook(File.Contents(FolderPath & "MasterData.xlsx"), null, true),
  Vendors = Master{[Name="Vendors"]}[Content],
  VendorsTyped = Table.TransformColumnTypes(Vendors, {{"VendorCode", type text},{"VendorName", type text}}),
  JoinVend = Table.NestedJoin(Dedup, {"VendorName"}, VendorsTyped, {"VendorName"}, "vend", JoinKind.LeftOuter),
  ExpVend = Table.ExpandTableColumn(JoinVend, "vend", {"VendorCode"}, {"VendorCode"}),
  FillVend = Table.ReplaceValue(ExpVend, null, "VEND-UNK", Replacer.ReplaceValue, {"VendorCode"}),
  Final = Table.RenameColumns(Table.TransformColumnTypes(FillVend, {{"InvoiceDate", type date}}), {{"PurchaseOrder","PONumber"},{"InvoiceDate","OrderDate"}}),
  AddStatus = Table.AddColumn(Final, "Status", each "Open", type text),
  Reorder = Table.ReorderColumns(AddStatus,{"PONumber","VendorCode","OrderDate","Status"})
in
  Reorder

POLines_From_AI (lines)
let
  FolderPath = FolderPath,
  AI = Excel.Workbook(File.Contents(FolderPath & "AI_Staging.xlsx"), null, true),
  T = AI{[Name="AI_Extract"]}[Content],
  Typed = Table.TransformColumnTypes(T, {{"PurchaseOrder", type text},{"ProductCode", type text},{"Quantity", Int64.Type},{"LineAmount", type number},{"InvoiceDate", type date}}),
  Grouped = Table.Group(Typed, {"PurchaseOrder"}, {{"Rows", each let s = Table.AddIndexColumn(_, "LineNo", 1, 1, Int64.Type) in s, type table}}),
  Expanded = Table.ExpandTableColumn(Grouped, "Rows", {"LineNo","ProductCode","Quantity","LineAmount","InvoiceDate"}),
  UnitPrice = Table.AddColumn(Expanded, "UnitPrice", each try Number.Round([LineAmount] / [Quantity], 2) otherwise null, type number),
  AddCols = Table.TransformColumnTypes(Table.TransformColumns(UnitPrice, {{"InvoiceDate", Date.From}}), {{"Quantity", Int64.Type}}),
  Final = Table.RenameColumns(AddCols, {{"PurchaseOrder","PONumber"},{"ProductCode","PartNo"},{"InvoiceDate","LastReceiptDate"}}),
  WithStatus = Table.AddColumn(Final, "Status", each "Open", type text),
  WithDue = Table.AddColumn(WithStatus, "DueDate", each null, type date),
  WithQtyOrd = Table.AddColumn(WithDue, "QtyOrdered", each null, Int64.Type),
  Reorder = Table.ReorderColumns(WithQtyOrd, {"PONumber","LineNo","PartNo","QtyOrdered","UnitPrice","DueDate","Quantity","LastReceiptDate","Status"}),
  RenameQty = Table.RenameColumns(Reorder, {{"Quantity","QtyReceived"}})
in
  RenameQty

PO_Combined_From_AI (header+lines)
let
  POH = PO_From_AI,
  POL = POLines_From_AI,
  Join = Table.NestedJoin(POL, {"PONumber"}, POH, {"PONumber"}, "hdr", JoinKind.LeftOuter),
  Exp = Table.ExpandTableColumn(Join, "hdr", {"VendorCode","OrderDate","Status"}, {"VendorCode","POOrderDate","POStatus"}),
  AddQtyOpen = Table.AddColumn(Exp, "QtyOpen", each Number.Max((try [QtyOrdered] otherwise 0) - (try [QtyReceived] otherwise 0), 0), Int64.Type),
  Reorder = Table.ReorderColumns(AddQtyOpen,{"PONumber","VendorCode","POOrderDate","POStatus","LineNo","PartNo","QtyOrdered","UnitPrice","DueDate","QtyReceived","LastReceiptDate","QtyOpen"})
in
  Reorder

Sales side
- If your AI extract includes `CustomerName`, `SalesOrder`, use the same pattern: distinct headers by `SalesOrder` → `SalesOrders`; add indexed lines → `SOLines`; then join for `SO_Combined`. The generator already outputs SO_Combined as a convenience.
